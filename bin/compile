#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -e

env_dir=$(cd "$3/" && pwd)
key=HONEYCOMB_WRITE_KEY

export "$key=$(cat "${env_dir}/${key}")"
[[ -z "${!key}" ]] && echo "-----> ${key} is missing or empty: unable to continue." && exit 1

echo "-----> Creating deploy Honeycomb Marker for ${SOURCE_VERSION}"

echo "HONEYCOMB_WRITE_KEY: ${HONEYCOMB_WRITE_KEY}"
curl https://api.honeycomb.io/1/markers/nomics \
  -X POST \
  -H "X-Honeycomb-Team: ${HONEYCOMB_WRITE_KEY}" \
  -d "{\"message\":\"nomics.com - ${SOURCE_VERSION}\", \"type\":\"deploy\"}"

echo "       Done!"